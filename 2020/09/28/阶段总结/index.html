<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="自从接手upm工作以来的个人总结工程方面：1、技术架构：dubbo + zookeeper + Spring boot以往开发web项目使用的框架都是Spring MVC，而upm使用的是dubbo + zookeeper + Spring boot。所以也借此学习了一下这个组合架构。 先说dubbo。dubbo的作用是服务发现，也就是项目架构由之前比较传统的MVC架构变成了provider+co">
<meta name="keywords" content="总结">
<meta property="og:type" content="article">
<meta property="og:title" content="阶段总结">
<meta property="og:url" content="https://haocdp.github.io/2020/09/28/阶段总结/index.html">
<meta property="og:site_name" content="Haoc_Dp">
<meta property="og:description" content="自从接手upm工作以来的个人总结工程方面：1、技术架构：dubbo + zookeeper + Spring boot以往开发web项目使用的框架都是Spring MVC，而upm使用的是dubbo + zookeeper + Spring boot。所以也借此学习了一下这个组合架构。 先说dubbo。dubbo的作用是服务发现，也就是项目架构由之前比较传统的MVC架构变成了provider+co">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://haocdp.github.io/images/20200928/1.png">
<meta property="og:image" content="https://haocdp.github.io/images/20200928/2.png">
<meta property="og:image" content="https://haocdp.github.io/images/20200928/3.png">
<meta property="og:updated_time" content="2020-09-28T10:09:23.762Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="阶段总结">
<meta name="twitter:description" content="自从接手upm工作以来的个人总结工程方面：1、技术架构：dubbo + zookeeper + Spring boot以往开发web项目使用的框架都是Spring MVC，而upm使用的是dubbo + zookeeper + Spring boot。所以也借此学习了一下这个组合架构。 先说dubbo。dubbo的作用是服务发现，也就是项目架构由之前比较传统的MVC架构变成了provider+co">
<meta name="twitter:image" content="https://haocdp.github.io/images/20200928/1.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/iron_man.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/iron_man.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/iron_man.png">
          
        
    
    <!-- title -->
    <title>阶段总结</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2020/08/05/Async-循环依赖/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://haocdp.github.io/2020/09/28/阶段总结/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://haocdp.github.io/2020/09/28/阶段总结/&text=阶段总结"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://haocdp.github.io/2020/09/28/阶段总结/&is_video=false&description=阶段总结"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=阶段总结&body=Check out this article: https://haocdp.github.io/2020/09/28/阶段总结/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://haocdp.github.io/2020/09/28/阶段总结/&name=阶段总结&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#自从接手upm工作以来的个人总结"><span class="toc-number">1.</span> <span class="toc-text">自从接手upm工作以来的个人总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#工程方面："><span class="toc-number">1.1.</span> <span class="toc-text">工程方面：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、技术架构：dubbo-zookeeper-Spring-boot"><span class="toc-number">1.1.1.</span> <span class="toc-text">1、技术架构：dubbo + zookeeper + Spring boot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、异常处理"><span class="toc-number">1.1.2.</span> <span class="toc-text">2、异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、日志记录"><span class="toc-number">1.1.3.</span> <span class="toc-text">3、日志记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、多环境项目部署"><span class="toc-number">1.1.4.</span> <span class="toc-text">4、多环境项目部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、Nginx"><span class="toc-number">1.1.5.</span> <span class="toc-text">5、Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、数据服务"><span class="toc-number">1.1.6.</span> <span class="toc-text">6、数据服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#稳定性方面："><span class="toc-number">1.2.</span> <span class="toc-text">稳定性方面：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、日志采集、metrics"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、日志采集、metrics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、报警策略"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、报警策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、监控"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、限流"><span class="toc-number">1.2.4.</span> <span class="toc-text">4、限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、切流"><span class="toc-number">1.2.5.</span> <span class="toc-text">5、切流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、降级"><span class="toc-number">1.2.6.</span> <span class="toc-text">6、降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、服务分级解耦"><span class="toc-number">1.2.7.</span> <span class="toc-text">7、服务分级解耦</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        阶段总结
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Haoc_Dp</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-09-28T09:59:05.000Z" itemprop="datePublished">2020-09-28</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/总结/">总结</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="自从接手upm工作以来的个人总结"><a href="#自从接手upm工作以来的个人总结" class="headerlink" title="自从接手upm工作以来的个人总结"></a>自从接手upm工作以来的个人总结</h1><h2 id="工程方面："><a href="#工程方面：" class="headerlink" title="工程方面："></a>工程方面：</h2><h3 id="1、技术架构：dubbo-zookeeper-Spring-boot"><a href="#1、技术架构：dubbo-zookeeper-Spring-boot" class="headerlink" title="1、技术架构：dubbo + zookeeper + Spring boot"></a>1、技术架构：<code>dubbo</code> + <code>zookeeper</code> + <code>Spring boot</code></h3><p>以往开发<code>web</code>项目使用的框架都是<code>Spring MVC</code>，而<code>upm</code>使用的是<code>dubbo</code> + <code>zookeeper</code> + <code>Spring boot</code>。所以也借此学习了一下这个组合架构。</p>
<p>先说<code>dubbo</code>。<code>dubbo</code>的作用是服务发现，也就是项目架构由之前比较传统的<code>MVC</code>架构变成了<code>provider</code>+<code>consumer</code>架构。这种<code>dubbo</code>架构将之前的<code>Model</code>层，也叫<code>service</code>层（<code>provider</code>）和<code>Controller</code>层（<code>consumer</code>）进行了分离。好处是进行了架构解耦，单独的service服务可以单独部署，可以同时给提供服务给多个消费者。坏处就是程序很繁琐，每次开发和部署都得启动多个工程项目、部署多个工程项目。</p>
<p><code>dubbo</code>是一个<code>RPC</code>功能的组件，其主要的原理是远程调用。在<code>service</code>服务中定义实现的方法，可以在<code>controller</code>中进行直接远程调用，而不是代码执行。简单的原理解释就是<code>provider</code>在注册中心注册自己可以提供服务的接口，注册内容包括IP、端口、服务方法等信息，而<code>consumer</code>从注册中心得知自己调用的接口实现方的配置信息，从而进行远程通信。远程通信的方式则是将自己的调用接口信息传到<code>provider</code>，<code>provider</code>接收到调用的方法之后，调用本地的代码获取返回数据再以网络通信的方式返回给<code>consumer</code>。<br>这里有一个简单的demo可以参考：<a href="https://github.com/wangzheng0822/codedesign/tree/master/com/xzg/cd/rpc" target="_blank" rel="noopener">链接</a>。</p>
<p>在上学的时候，曾经捣鼓过<code>storm</code>+<code>zookeeper</code>的架构。当时对<code>zookeeper</code>还不太理解其功能是什么。现在理解了。<code>zookeeper</code>从字面意思上理解就是动物园管理员，管理各种各样的动物。所以这个组件的功能是分布式配置、同步、命名注册服务。</p>
<p>上面讲述<code>dubbo</code>的时候提到了注册中心，<code>zookeeper</code>就是那个注册中心。<code>dubbo</code>为了可以做服务发现，需要把<code>provider</code>的接口注册到<code>zookeeper</code>中，而<code>consumer</code>则可以从<code>zookeeper</code>找到现在可用的接口。</p>
<p><code>zookeeper</code>的特点就是可以做高可用的分布式协同。当作注册中心，需要保障注册信息的高可用性。高可用性的方式就是多台机器进行集群管理，通过节点选举算法保证集群稳定。</p>
<p>最后说一下<code>Spring boot</code>。<code>Spring boot</code>之前在我的印象中就是<code>Spring MVC</code>的简化版，易操作版。其实，它的定位就是高度封装的<code>Spring MVC</code>，可以快速进行项目开发和部署，迎合了现在很火的微服务。可以借助<code>Spring boot</code>快速搭建一个web系统，封装了相关的<code>Spring</code>包和<code>web</code>容器。所有的项目信息也都可以使用<code>Java Config</code>的方式进行配置。项目整体搭建、配置下来非常方便快捷。</p>
<h3 id="2、异常处理"><a href="#2、异常处理" class="headerlink" title="2、异常处理"></a>2、异常处理</h3><p><code>upm</code>的异常处理使用Spring中的<code>@ExceptionHandler</code>统一切片处理方法中产生的异常。这里说的异常一般都是<code>Controller</code>层产生的异常，产生的异常可以分门别类在切片类中统一处理。这样做的好处是不用在代码中考虑异常处理问题，专注于业务逻辑。还有一个好处是所有的异常情况都可以使用异常类进行封装并抛出。</p>
<p>比如，之前写代码对于异常情况的处理时，记录日志，并把异常信息封装成<code>ResponseEntity</code>进行返回。这里的<code>ResponseEntity</code>包含错误码，错误信息。每次进行异常处理都会把错误码和错误信息在业务代码中进行填充，十分繁琐。并且考虑到异常及时返回的原则，只要碰到异常情况，就应该提前结束方法，使用<code>return</code>。如果在方法中调用了其他方法，并且在被调用的方法中出现了异常情况，这是需要单独对被调用方法的返回进行特殊处理，判断是否发生了异常，如果发生了异常则直接返回，否则进行下面的逻辑处理。</p>
<p>而使用了统一的异常处理之后，无论在哪个方法发生了异常情况，直接<code>throw</code>就完事了。</p>
<h3 id="3、日志记录"><a href="#3、日志记录" class="headerlink" title="3、日志记录"></a>3、日志记录</h3><p>日志应该分为三类：第一类是审计日志，什么人在什么时间做了什么操作，这类日志需要记录清楚操作记录；第二类是对外接口日志，哪个子系统在什么时间调用了什么接口，接口参数是什么，返回是什么。第三类是代码执行过程中异常信息记录，用于排查系统异常问题。</p>
<ul>
<li>第一类日志应该入库甚至<code>Kafka</code>、<code>Hive</code>等离线表，用于后续的用户行为分析和审查。</li>
<li>第二类日志主要记录在日志文件中，方便系统出现异常排查、监控、报警等使用，主要的作用是能够追溯到谁使用了什么功能，参数是什么，返回是什么，请求量是多少。</li>
<li>第三类日志记录在日志文件中，主要用于系统问题排查。</li>
</ul>
<p>日志文件主要分为了两类：<code>info</code>信息和<code>err</code>信息。两类信息分类可以方便问题排查。</p>
<h3 id="4、多环境项目部署"><a href="#4、多环境项目部署" class="headerlink" title="4、多环境项目部署"></a>4、多环境项目部署</h3><p><code>upm</code>为了规范开发、测试、部署流程，保证线上系统的稳定，部署了多套系统。</p>
<ul>
<li>国内生产环境</li>
<li>美东生产环境</li>
<li>国内预发环境</li>
<li><code>stable</code>测试环境</li>
<li><code>dev</code>测试环境</li>
</ul>
<p>部署不同的环境针对不同使用场景，可以保证开发的功能在<code>dev</code>测试环境中充分测试，在预发环境中充分验收，然后部署到生产环境。<code>stable</code>环境提供给公司其他团队进行对接测试。</p>
<h3 id="5、Nginx"><a href="#5、Nginx" class="headerlink" title="5、Nginx"></a>5、<code>Nginx</code></h3><p><code>Nginx</code>的主要两个作用是<strong>服务转发</strong>和<strong>负载均衡</strong>。<br>使用<strong>服务转发</strong>功能，可以将浏览器的请求转发到服务器上，获取到指定路径下的前端页面。然后把前端页面的后端服务请求转发到指定的域名或者服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  upm-indicators.xiaojukeji.com;</span><br><span class="line">    rewrite_log  on;</span><br><span class="line">    root /home/xiaoju/IAMFireman/;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location ~ ^/static/ &#123;</span><br><span class="line">        root /home/xiaoju/IAMFireman/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>负载均衡</strong>功能是在集群环境下，把请求流量导向到哪些机器上，以及这些机器的流量比例是多少。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">upstream upm_core_api &#123;</span><br><span class="line">    #server 127.0.0.1:8099 weight=8;</span><br><span class="line">    #server 127.0.0.1:8088 weight=2;</span><br><span class="line"></span><br><span class="line">    #只有core 8099挂了，才反向代理到upm-api8088</span><br><span class="line">    server 127.0.0.1:8099;</span><br><span class="line">    server 127.0.0.1:8088 backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Nginx</code>还有一个功能是最近刚发现的。我们都知道前端浏览器针对Ajax请求有跨域限制。想要解决跨域问题需要<code>Nginx</code>中配置允许跨域，这样前端页面才可以正常请求到后端数据。这种配置方式针对<code>web</code>服务来说没什么问题。但是有另外一种情况需要注意 —— <code>API</code>接口。</p>
<p><code>API</code>接口是提供给外部单独的数据服务接口，并且有<code>token</code>认证机制。如果前端直接调用<code>API</code>接口，那么需要把认证信息加到请求参数或者<code>Header</code>中，势必会有泄漏<code>token</code>信息的风险。因此，一般<code>API</code>接口只提供服务端访问，不支持前端访问。做这种限制的方式就是<code>API</code>接口不允许跨域访问，在<code>Nginx</code>中就可以限制。</p>
<h3 id="6、数据服务"><a href="#6、数据服务" class="headerlink" title="6、数据服务"></a>6、数据服务</h3><p>数据服务是指把系统中的数据放入<code>Hive</code>、<code>Hbase</code>、<code>ES</code>等离线库中。放入这些库中主要是为了支撑一些数据分析工作，比如想要查询哪些人有哪些系统的哪些权限。如果这个功能在线上系统上会占用数据库资源，影响正常服务的提供。因此，会考虑把实时性要求不那么高的数据查询和分析工作放到大数据平台进行。</p>
<p>离线任务包括一些数据的清洗、提取关键信息、报表生成和数据查询。举几个例子。</p>
<ol>
<li>第一次做离线任务是为了拉取<code>Hive</code>表中的数据审批记录。原始<code>Hive</code>表中有很多数据字段，而我只需要我所关心的某几个字段，所以把数据进行清洗、字典转换等工作后存入到自己的数据库中，提供服务。</li>
<li>大数据平台还提供了数据查询服务，建立好数据查询模板，每天定时任务就可以把数据以邮件的方式发给你。</li>
</ol>
<p>除了离线任务外，也可以做一些实时计算的工作。比如<code>upm</code>中的申请系统推荐功能。<br>用户进入系统申请权限页面后，会选择子系统进行权限申请。但是，由于子系统很多，用户可能不知道自己想要申请权限的系统名称是什么？所以这里页面就会展示用户可能想要申请的子系统名称。那这是什么做到的呢？</p>
<p>其实，原理很简单。</p>
<ol>
<li>用户<code>A</code>在申请权限之前会去想要使用的系统<code>A</code>进行相关工作，系统<code>A</code>在用户<code>A</code>进入页面之后会调用<code>upm</code>鉴权接口进行鉴权，鉴权成功允许用户<code>A</code>访问，鉴权失败则不允许访问。鉴权成功失败与否，在<code>upm</code>中都有日志记录。</li>
<li>用户<code>A</code>没有权限就会去<code>upm</code>申请权限，这是我们认为用户<code>A</code>鉴权失败的子系统<code>A</code>就是用户想要申请权限的系统，推荐给用户<code>A</code>。</li>
<li>推荐问题有很强的实时性，用户<code>A</code>访问完系统<code>A</code>之后，可能就会立即去<code>upm</code>申请权限。因此需要实时处理鉴权失败日志，进行数据清洗、聚合，找到用户鉴权失败的系统，并计算可能访问系统的概率。</li>
</ol>
<p>实现方式是把鉴权日志打入<code>Kafka</code>，使用<code>Flink</code>消费日志，数据清洗、聚合之后把结果打入下游<code>Kafka</code>，消费下游<code>Kafka</code>的数据并入<code>Redis</code>以供推荐调用。<br><img src="../../../../images/20200928/1.png" alt="avatar"></p>
<p>Flink是一个实时计算组件，需要再学习一下。</p>
<h2 id="稳定性方面："><a href="#稳定性方面：" class="headerlink" title="稳定性方面："></a>稳定性方面：</h2><h3 id="1、日志采集、metrics"><a href="#1、日志采集、metrics" class="headerlink" title="1、日志采集、metrics"></a>1、日志采集、<code>metrics</code></h3><p>日志采集是使用公司的监控平台，实时采集系统的日志并进行相关数据的计算，比如<code>QPS</code>、报错数等。<br><img src="../../../../images/20200928/2.png" alt="avatar"></p>
<p><code>metrics</code>则是系统埋点，比如记录<code>dubbo</code>调用<code>service</code>方法的时间。</p>
<h3 id="2、报警策略"><a href="#2、报警策略" class="headerlink" title="2、报警策略"></a>2、报警策略</h3><p>报警策略是在日志采集和埋点的基础上，配置策略。如果系统流量异常，短时间大量请求进来可能会压垮服务器，这是我们就可以配置一个报警策略是当<code>QPS</code>大于某个阈值时进行报警，运维人员查看系统状态和请求详情。</p>
<p>除了我们自己配置的采集之外，公司系统还有基础配置，包括机器的资源使用情况（<code>CPU</code>、内存、磁盘、网络等）。</p>
<h3 id="3、监控"><a href="#3、监控" class="headerlink" title="3、监控"></a>3、监控</h3><p>监控以图表的方式展现系统的状况<br><img src="../../../../images/20200928/3.png" alt="avatar"></p>
<h3 id="4、限流"><a href="#4、限流" class="headerlink" title="4、限流"></a>4、限流</h3><p><code>upm</code>中接入了很多系统，每个系统都有可能在不同时间访问<code>upm</code>系统。如果某一个子系统访问<code>upm</code>系统突然很频繁，<code>QPS</code>爆涨，占用了机器的全部资源。那么此时其他子系统就无法访问<code>upm</code>系统，<code>upm</code>系统就处于瘫痪状态，影响所有的子系统使用。</p>
<p>为了防止这种情况的发生，应该限制子系统发生大量异常请求的发起。但是我们又无法限制子系统调用方的动作，那么我们只能在<code>upm</code>系统上加上限流措施。限制子系统最大的流量阈值是<code>q</code>，超过阈值则不再处理请求直接返回。</p>
<p>使用限流策略，当<code>upm</code>系统支撑不了太大的流量时对某些子系统进行忽略，保障了大多数系统的正常使用。</p>
<h3 id="5、切流"><a href="#5、切流" class="headerlink" title="5、切流"></a>5、切流</h3><p>切流的动作发生的时机是当某个机房的服务发生异常，无法正常提供服务，那么就把流量切到另外一个机房。切流策略是为了止损，防止系统发生异常，服务无法提供。</p>
<p>切流操作的前提是服务多机房部署。多机房部署的好处是当某个机房发生断电、机器故障等问题时，可以及时把流量切到另外一个机房，提高服务的高可用性。</p>
<h3 id="6、降级"><a href="#6、降级" class="headerlink" title="6、降级"></a>6、降级</h3><p>一个高可用、稳定的服务系统，使用的存储组件肯定不止数据库一种，还需搭配缓存服务提高请求速度和并发度。常见的架构是<code>Redis</code> + <code>Mysql</code>的搭配。服务接口一般会从<code>Redis</code>中查询数据，如果<code>Redis</code>服务不可用或者异常较多，则从<code>Mysql</code>中查询数据。</p>
<p>这样从<code>Redis</code>请求数据到<code>Mysql</code>请求数据的过程就是一个简单的降级服务。</p>
<p>降级一般指的是系统在请求某个外部服务时出现异常，请求不到正常数据，就会阻塞本系统的功能。如果有重试机制或者线程阻塞，就会导致消耗大量系统资源，造成雪崩效应，整个服务不可用。因此，降级策略可以保证当上述情况发生时，就不再请求不可用服务，调用本地服务或者直接返回，不进行任何处理。由此可见，降级也是止损的一种策略。</p>
<h3 id="7、服务分级解耦"><a href="#7、服务分级解耦" class="headerlink" title="7、服务分级解耦"></a>7、服务分级解耦</h3><p>传统的系统会把<code>web</code>接口、<code>api</code>接口放在一个工程项目中，统一进行部署。但是<code>web</code>接口和<code>api</code>接口的性质不同，导致可能系统只需要改一个页面小问题都需要重新部署。如果<code>API</code>接口的<code>QPS</code>很高，就有可能影响<code>API</code>接口提供服务，严重可能导致服务不可用。</p>
<p><code>upm</code>的鉴权接口是特别重要、<code>QPS</code>很高的接口，不能容忍不可用的情况。因此，为了鉴权接口的高可用性和稳定性，把核心鉴权接口单独拎出来作为一个服务单独部署。日常系统的迭代开发不会影响核心鉴权接口，去除系统管理代码和鉴权代码的耦合。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#自从接手upm工作以来的个人总结"><span class="toc-number">1.</span> <span class="toc-text">自从接手upm工作以来的个人总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#工程方面："><span class="toc-number">1.1.</span> <span class="toc-text">工程方面：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、技术架构：dubbo-zookeeper-Spring-boot"><span class="toc-number">1.1.1.</span> <span class="toc-text">1、技术架构：dubbo + zookeeper + Spring boot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、异常处理"><span class="toc-number">1.1.2.</span> <span class="toc-text">2、异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、日志记录"><span class="toc-number">1.1.3.</span> <span class="toc-text">3、日志记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、多环境项目部署"><span class="toc-number">1.1.4.</span> <span class="toc-text">4、多环境项目部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、Nginx"><span class="toc-number">1.1.5.</span> <span class="toc-text">5、Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、数据服务"><span class="toc-number">1.1.6.</span> <span class="toc-text">6、数据服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#稳定性方面："><span class="toc-number">1.2.</span> <span class="toc-text">稳定性方面：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、日志采集、metrics"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、日志采集、metrics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、报警策略"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、报警策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、监控"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、限流"><span class="toc-number">1.2.4.</span> <span class="toc-text">4、限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、切流"><span class="toc-number">1.2.5.</span> <span class="toc-text">5、切流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6、降级"><span class="toc-number">1.2.6.</span> <span class="toc-text">6、降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7、服务分级解耦"><span class="toc-number">1.2.7.</span> <span class="toc-text">7、服务分级解耦</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://haocdp.github.io/2020/09/28/阶段总结/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://haocdp.github.io/2020/09/28/阶段总结/&text=阶段总结"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://haocdp.github.io/2020/09/28/阶段总结/&is_video=false&description=阶段总结"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=阶段总结&body=Check out this article: https://haocdp.github.io/2020/09/28/阶段总结/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://haocdp.github.io/2020/09/28/阶段总结/&title=阶段总结"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://haocdp.github.io/2020/09/28/阶段总结/&name=阶段总结&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 haoc_dp
  </div>
  <!-- <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div> -->
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-148173917-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
