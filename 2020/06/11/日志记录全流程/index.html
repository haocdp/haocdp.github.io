<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="这个博文记录一下我在一个实际项目开发过程中的日志记录节点和信息。 不一定是最完美的，但是算是自己的一次尝试。 以后如果有更好的方案再改进。  先说下背景。进入公司半年后，我自己负责了一个系统的后端开发工作。通过这个工作，算是把公司整个项目的开发流程整明白了。这个开发流程包括从项目开始立项的需求讨论、需求分析，到系统设计、详细设计，再到数据结构设计、接口设计、前后端分工，最后完成开发工作。我的主要工">
<meta name="keywords" content="日志">
<meta property="og:type" content="article">
<meta property="og:title" content="日志记录全流程">
<meta property="og:url" content="https://haocdp.github.io/2020/06/11/日志记录全流程/index.html">
<meta property="og:site_name" content="Haoc_Dp">
<meta property="og:description" content="这个博文记录一下我在一个实际项目开发过程中的日志记录节点和信息。 不一定是最完美的，但是算是自己的一次尝试。 以后如果有更好的方案再改进。  先说下背景。进入公司半年后，我自己负责了一个系统的后端开发工作。通过这个工作，算是把公司整个项目的开发流程整明白了。这个开发流程包括从项目开始立项的需求讨论、需求分析，到系统设计、详细设计，再到数据结构设计、接口设计、前后端分工，最后完成开发工作。我的主要工">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-06-24T09:00:30.542Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="日志记录全流程">
<meta name="twitter:description" content="这个博文记录一下我在一个实际项目开发过程中的日志记录节点和信息。 不一定是最完美的，但是算是自己的一次尝试。 以后如果有更好的方案再改进。  先说下背景。进入公司半年后，我自己负责了一个系统的后端开发工作。通过这个工作，算是把公司整个项目的开发流程整明白了。这个开发流程包括从项目开始立项的需求讨论、需求分析，到系统设计、详细设计，再到数据结构设计、接口设计、前后端分工，最后完成开发工作。我的主要工">
    
    
        
          
              <link rel="shortcut icon" href="/images/iron_man.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/iron_man.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/iron_man.png">
          
        
    
    <!-- title -->
    <title>日志记录全流程</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/08/05/Async-循环依赖/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/06/11/日志记录与Request-Response-Wrapper类/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://haocdp.github.io/2020/06/11/日志记录全流程/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&text=日志记录全流程"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&is_video=false&description=日志记录全流程"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=日志记录全流程&body=Check out this article: https://haocdp.github.io/2020/06/11/日志记录全流程/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&name=日志记录全流程&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-后端分层日志记录"><span class="toc-number">1.</span> <span class="toc-text">0x01 后端分层日志记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-接口类型"><span class="toc-number">2.</span> <span class="toc-text">0x02 接口类型</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        日志记录全流程
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Haoc_Dp</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-06-11T06:43:35.000Z" itemprop="datePublished">2020-06-11</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/日志/">日志</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>这个博文记录一下我在一个实际项目开发过程中的日志记录节点和信息。</p>
<p>不一定是最完美的，但是算是自己的一次尝试。</p>
<p>以后如果有更好的方案再改进。</p>
<hr>
<p>先说下背景。进入公司半年后，我自己负责了一个系统的后端开发工作。通过这个工作，算是把公司整个项目的开发流程整明白了。这个开发流程包括从项目开始立项的需求讨论、需求分析，到系统设计、详细设计，再到数据结构设计、接口设计、前后端分工，最后完成开发工作。我的主要工作是系统设计和后端开发，通过这次的开发任务，对系统设计算是入个小小的门，对后端开发也有了新的认识。其中，最大的认识就是如何做日志记录以及稳定性建设的工作。</p>
<p>稳定性建设是我之前从来没有接触过的东西，我这次做的也并不是很完善，有很多需要改进的地方。这篇文章里就不说了。</p>
<p>主要还是说一下<strong>日志记录的全流程</strong>。</p>
<p>之前接触过的系统日志记录都相对比较简陋，而且有很多代码冗余和难以维护的点。比如，为了记录接口的参数和返回值，直接把<code>log.info/debug</code>写入到方法里。这样的方式导致的结果就是每次新增方法都需要重新写这部分日志记录代码，在业务代码中就会有很多这样日志记录代码。还有一个点是，为了能在日志中体现日志所在的方法，就必须在打印日志时把方法名称带上。</p>
<p>为了更好的记录日志，我把日志记录分为了几个层次。从后端分层来看，分为了controller层和service层。从接口的类型来看，分为了API接口和web接口。针对不同的分类，日志的记录也是不同的。</p>
<h2 id="0x01-后端分层日志记录"><a href="#0x01-后端分层日志记录" class="headerlink" title="0x01 后端分层日志记录"></a>0x01 后端分层日志记录</h2><p>controller层和service层最大的不同就是，controller层的外层可以使用拦截器，而service层不行。也就是说controller层的日志记录可以放在拦截器里进行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统trace日志记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chenghao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020-05-13 11:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceLogInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(TRACE_LOG);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 设置请求开始时间</span></span><br><span class="line">        String traceId = request.getHeader(TraceConsts.DIDI_HEADER_RID);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(traceId)) &#123;</span><br><span class="line">            logger.warn(<span class="string">"method:traceLog not found traceId"</span>);</span><br><span class="line">            traceId = SpanIdGenerator.getTraceId();</span><br><span class="line">        &#125;</span><br><span class="line">        MDC.put(TraceConsts.TRACEID, traceId); <span class="comment">//公司日志记录工具类</span></span><br><span class="line">        LogMessage.setTraceId(traceId); <span class="comment">//公司日志记录工具类</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//上游的传递的spanid</span></span><br><span class="line">        String spanId = request.getHeader(TraceConsts.DIDI_HEADER_SPANID);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(spanId)) &#123;</span><br><span class="line">            spanId = SpanIdGenerator.getSpanId();</span><br><span class="line">        &#125;</span><br><span class="line">        MDC.put(TraceConsts.SPANID, spanId);</span><br><span class="line">        LogMessage.setSpanId(spanId);</span><br><span class="line"></span><br><span class="line">        String hintCode = request.getHeader(TraceConsts.DIDI_HEADER_HINT_CODE);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(hintCode)) &#123;</span><br><span class="line">            hintCode = <span class="string">"0"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Long hc = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hc = Long.parseLong(hintCode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        MDC.put(TraceConsts.HINT_CODE, hc.toString());</span><br><span class="line">        LogMessage.setHintCode(hc);</span><br><span class="line"></span><br><span class="line">        String hintContent = request.getHeader(TraceConsts.DIDI_HEADER_HINT_CONTENT);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(hintContent)) &#123;</span><br><span class="line">            hintContent = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        MDC.put(TraceConsts.HINT_CONTENT, hintContent);</span><br><span class="line">        LogMessage.setHintContent(hintContent);</span><br><span class="line"></span><br><span class="line">        request.setAttribute(<span class="string">"startTime"</span>, System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(DltagConsts._COM_REQUEST_IN);</span><br><span class="line">        logMessage.add(TraceConsts.URI, request.getRequestURI());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果接口是上传文件，则忽略该参数</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(request.getContentType())</span><br><span class="line">                &amp;&amp; request.getContentType().startsWith(ContentType.MULTIPART_FORM_DATA.getMimeType())) &#123;</span><br><span class="line">            logMessage.add(<span class="string">"args"</span>, <span class="string">""</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (POST.name().equals(request.getMethod())) &#123;</span><br><span class="line">                BufferedReader reader = request.getReader();</span><br><span class="line">                String line = <span class="string">""</span>;</span><br><span class="line">                StringBuilder args = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    args.append(line.trim());</span><br><span class="line">                &#125;</span><br><span class="line">                logMessage.add(<span class="string">"args"</span>, args.toString());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logMessage.add(<span class="string">"args"</span>, JSON.toJSONString(request.getParameterMap()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(logMessage.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(DltagConsts._COM_REQUEST_OUT);</span><br><span class="line">        logMessage.add(TraceConsts.URI, request.getRequestURI());</span><br><span class="line">        <span class="keyword">long</span> startTime = (Long)request.getAttribute(<span class="string">"startTime"</span>);</span><br><span class="line">        logMessage.add(TraceConsts.PROC_TIME, (System.currentTimeMillis() - startTime)/<span class="number">1000.0</span>);</span><br><span class="line">        <span class="keyword">if</span> (ex != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logMessage.add(TraceConsts.ERRNO, <span class="number">500</span>);</span><br><span class="line">            <span class="keyword">if</span> (ex.getCause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logMessage.add(TraceConsts.ERRMSG, ex.getCause().getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logMessage.add(TraceConsts.ERRNO, <span class="number">200</span>);</span><br><span class="line">            logMessage.add(TraceConsts.ERRMSG, <span class="string">"success"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 排除掉后台运维接口的日志</span></span><br><span class="line">        <span class="keyword">if</span> (!request.getRequestURI().startsWith(<span class="string">"/admin"</span>)) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] body = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (response <span class="keyword">instanceof</span> ContentCachingResponseWrapper) &#123;</span><br><span class="line">                body = ((ContentCachingResponseWrapper) response).getContentAsByteArray();</span><br><span class="line">            &#125;</span><br><span class="line">            logMessage.add(<span class="string">"result"</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(logMessage.toString());</span><br><span class="line">        MDC.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过拦截器我们可以很方便的记录每个controller方法的参数和返回值。在这里我们不仅仅记录了方法的参数是什么，返回是什么，还记录请求uri、请求响应时间、traceId、spanid、cspanid。后面三个值是为了进行全链路日志查询。关于traceId在这里就不多说了。</p>
<p>但是service层没有拦截器应该怎么办？首先，我们应该知道的是拦截器的原理是使用面向切面的编程在controller的外层加了一层处理逻辑。那么，我们也可以参照这个思路在service层外也加一层日志记录的代码逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SOC全局日志记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chenghao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020-05-12 17:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Log log;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.didichuxing.soc.common.annotation.LogAnnotation)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">annotationPointCut</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"annotationPointCut()&amp;&amp;@annotation(logAnnotation)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint, LogAnnotation logAnnotation)</span></span>&#123;</span><br><span class="line">        log = LogFactory.getLog(logAnnotation.loggerName());</span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(<span class="string">"_com_method_in"</span>);</span><br><span class="line">        logMessage.add(<span class="string">"method"</span>, getClassAndMethodName(joinPoint));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (joinPoint.getArgs() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object[] args = joinPoint.getArgs().clone();</span><br><span class="line">            <span class="comment">// 隐去登录用户的隐私数据，只保留ID、邮箱、账号</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                Object arg = args[i];</span><br><span class="line">                <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> LoginUser) &#123;</span><br><span class="line">                    Object copyArg = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        copyArg = ((LoginUser) arg).clone();</span><br><span class="line">                        ((LoginUser) copyArg).setPhone(<span class="keyword">null</span>);</span><br><span class="line">                        ((LoginUser) copyArg).setPicture(<span class="keyword">null</span>);</span><br><span class="line">                        ((LoginUser) copyArg).setRealname(<span class="keyword">null</span>);</span><br><span class="line">                        ((LoginUser) copyArg).setTicket(<span class="keyword">null</span>);</span><br><span class="line">                        ((LoginUser) copyArg).setUserno(<span class="keyword">null</span>);</span><br><span class="line">                        ((LoginUser) copyArg).setRoles(<span class="keyword">null</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">                        log.error(<span class="string">"method:LogAspect.before ret: clone not Supported."</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    args[i] = copyArg;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果参数为文件，则排除</span></span><br><span class="line">                <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> MultipartFile) &#123;</span><br><span class="line">                    args[i] = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            String argsStr = JSON.toJSONString(args);</span><br><span class="line">            logMessage.add(<span class="string">"args"</span>, argsStr);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logMessage.add(<span class="string">"args"</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取参数列表</span></span><br><span class="line">        log.info(logMessage.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(value = <span class="string">"annotationPointCut()&amp;&amp;@annotation(logAnnotation)"</span>,returning = <span class="string">"result"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturn</span><span class="params">(JoinPoint joinPoint, Object result, LogAnnotation logAnnotation)</span></span>&#123;</span><br><span class="line">        log = LogFactory.getLog(logAnnotation.loggerName());</span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(<span class="string">"_com_method_out"</span>);</span><br><span class="line">        logMessage.add(<span class="string">"method"</span>, getClassAndMethodName(joinPoint));</span><br><span class="line">        <span class="comment">//获取返回值</span></span><br><span class="line">        String resultString = JSON.toJSONString(result);</span><br><span class="line">        logMessage.add(<span class="string">"result"</span>, resultString);</span><br><span class="line">        logMessage.add(TraceConsts.ERRNO, <span class="number">0</span>);</span><br><span class="line">        logMessage.add(TraceConsts.ERRMSG, <span class="string">"success"</span>);</span><br><span class="line">        log.info(logMessage.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"annotationPointCut()&amp;&amp;@annotation(logAnnotation)"</span>,throwing = <span class="string">"ex"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(JoinPoint joinPoint, Exception ex, LogAnnotation logAnnotation)</span></span>&#123;</span><br><span class="line">        log = LogFactory.getLog(logAnnotation.loggerName());</span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(<span class="string">"_com_method_fail"</span>);</span><br><span class="line">        logMessage.add(<span class="string">"method"</span>, getClassAndMethodName(joinPoint));</span><br><span class="line">        logMessage.add(TraceConsts.ERRNO, <span class="number">1</span>);</span><br><span class="line">        String msg = ex.getCause() == <span class="keyword">null</span> ? ex.getMessage() : ex.getCause().getMessage();</span><br><span class="line">        logMessage.add(TraceConsts.ERRMSG, msg);</span><br><span class="line">        log.error(logMessage.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据切入点获取类名和方法名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint 切入点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $&#123;className&#125;-$&#123;methodName&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getClassAndMethodName</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        String className = joinPoint.getSignature().getDeclaringTypeName();</span><br><span class="line">        String methodName = joinPoint.getSignature().getName();</span><br><span class="line">        <span class="keyword">return</span> className + <span class="string">"."</span> + methodName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在service层的日志记录和controller层大体相同，唯一不同的地方就是增加了调用方法的信息记录。</p>
<p>这样的日志记录可以覆盖到所有的请求方法的参数和返回值，方便于问题的排查。当然这仅仅是对方法的参数的返回值的记录，还有一个比较重要的日志记录是方法内的异常情况日志记录。比如，如果方法参数不符合要求，我们可以使用<code>warn</code>级别的日志进行记录，而异常情况的发生使用<code>error</code>级别进行记录。这样只要系统发生了异常情况，我们就可以从请求的参数、返回值、异常发生的上下文信息进行问题定位。为了更符合我们现在的日志记录，我在log4j的日志方法外又封装了一层。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Soc平台报错、告警日志记录接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chenghao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2020-05-14 11:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SocLog</span> </span>&#123;</span><br><span class="line">    Log logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogger</span><span class="params">(Log logger)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录方法执行过程中的错误日志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 错误原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录方法执行过程中的错误日志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 错误原因</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e 报错信息参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String message, Throwable e)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录方法执行过程中的告警日志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 告警原因</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(value = <span class="string">"socLog"</span>)</span><br><span class="line"><span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TraceLog</span> <span class="keyword">extends</span> <span class="title">SocLog</span> </span>&#123;</span><br><span class="line">    HttpRequestAdapter httpRequestAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"saMonitorRobotRequestHandler"</span>)</span><br><span class="line">    HttpRequestHandler httpRequestHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskExecutor targetExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TraceLog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.httpRequestAdapter = <span class="keyword">new</span> HttpRequestAdapter(<span class="keyword">new</span> SaMonitorRobotRequestHandler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (logger == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(<span class="string">"_com_method_error"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前方法调用者信息</span></span><br><span class="line">        StackTraceElement[] arr = Thread.currentThread().getStackTrace();</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder(<span class="number">100</span>);</span><br><span class="line">        stringBuilder.append(arr[<span class="number">2</span>].getClassName())</span><br><span class="line">                .append(<span class="string">'('</span>)</span><br><span class="line">                .append(arr[<span class="number">2</span>].getMethodName())</span><br><span class="line">                .append(<span class="string">':'</span>)</span><br><span class="line">                .append(arr[<span class="number">2</span>].getLineNumber())</span><br><span class="line">                .append(<span class="string">')'</span>);</span><br><span class="line">        String method = stringBuilder.toString();</span><br><span class="line">        logMessage.add(<span class="string">"method"</span>, method);</span><br><span class="line">        logMessage.add(<span class="string">"message"</span>, message);</span><br><span class="line">        logger.error(logMessage.toString());</span><br><span class="line"></span><br><span class="line">        PropertiesUtil propertiesUtil = PropertiesUtil.load(<span class="string">"config.properties"</span>);</span><br><span class="line">        String env = propertiesUtil.getProValue(<span class="string">"soc.deploy.env"</span>);</span><br><span class="line">        String envName = <span class="string">"线上环境"</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"dev"</span>.equals(env))&#123;</span><br><span class="line">            envName = <span class="string">"测试环境"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String text = <span class="string">"**环境类型：** "</span> + envName + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**请求方法：** "</span> + method + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**traceId：** "</span> + logMessage.getTraceId() + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**spanId：** "</span> + logMessage.getSpanId() + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**cspanId：** "</span> + logMessage.getCspanId() + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**报错信息：** "</span> + message;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, String&gt; content = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        content.put(<span class="string">"text"</span>, text);</span><br><span class="line">        targetExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    httpRequestAdapter.handle(<span class="keyword">null</span>, <span class="keyword">null</span>, content);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BaseException e) &#123;</span><br><span class="line">                    logger.error(<span class="string">"send sa monitor message error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String message, Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (logger == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(<span class="string">"_com_method_error"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前方法调用者信息</span></span><br><span class="line">        StackTraceElement[] arr = Thread.currentThread().getStackTrace();</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder(<span class="number">100</span>);</span><br><span class="line">        stringBuilder.append(arr[<span class="number">2</span>].getClassName())</span><br><span class="line">                .append(<span class="string">'('</span>)</span><br><span class="line">                .append(arr[<span class="number">2</span>].getMethodName())</span><br><span class="line">                .append(<span class="string">':'</span>)</span><br><span class="line">                .append(arr[<span class="number">2</span>].getLineNumber())</span><br><span class="line">                .append(<span class="string">')'</span>);</span><br><span class="line">        String method = stringBuilder.toString();</span><br><span class="line">        logMessage.add(<span class="string">"method"</span>, method);</span><br><span class="line">        logMessage.add(<span class="string">"message"</span>, message);</span><br><span class="line">        logMessage.add(<span class="string">"exception"</span>, getExceptionMessage(e));</span><br><span class="line">        logger.error(logMessage.toString());</span><br><span class="line"></span><br><span class="line">        PropertiesUtil propertiesUtil = PropertiesUtil.load(<span class="string">"config.properties"</span>);</span><br><span class="line">        String env = propertiesUtil.getProValue(<span class="string">"soc.deploy.env"</span>);</span><br><span class="line">        String envName = <span class="string">"线上环境"</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"dev"</span>.equals(env))&#123;</span><br><span class="line">            envName = <span class="string">"测试环境"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String text = <span class="string">"**环境类型：** "</span> + envName + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**请求方法：** "</span> + method + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**traceId：** "</span> + logMessage.getTraceId() + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**spanId：** "</span> + logMessage.getSpanId() + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**cspanId：** "</span> + logMessage.getCspanId() + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**报错信息：** "</span> + message + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"**异常信息：** \n\n"</span></span><br><span class="line">                + <span class="string">"```\n\n"</span></span><br><span class="line">                + getExceptionMessage(e) + <span class="string">"\n\n"</span></span><br><span class="line">                + <span class="string">"```\n\n"</span>;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, String&gt; content = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        content.put(<span class="string">"text"</span>, text);</span><br><span class="line">        targetExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    httpRequestAdapter.handle(<span class="keyword">null</span>, <span class="keyword">null</span>, content);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BaseException e) &#123;</span><br><span class="line">                    logger.error(<span class="string">"send sa monitor message error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (logger == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LogMessage logMessage = <span class="keyword">new</span> LogMessage();</span><br><span class="line">        logMessage.setDltag(<span class="string">"_com_method_warn"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前方法调用者信息</span></span><br><span class="line">        StackTraceElement[] arr = Thread.currentThread().getStackTrace();</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder(<span class="number">100</span>);</span><br><span class="line">        stringBuilder.append(arr[<span class="number">2</span>].getClassName())</span><br><span class="line">                .append(<span class="string">'('</span>)</span><br><span class="line">                .append(arr[<span class="number">2</span>].getMethodName())</span><br><span class="line">                .append(<span class="string">':'</span>)</span><br><span class="line">                .append(arr[<span class="number">2</span>].getLineNumber())</span><br><span class="line">                .append(<span class="string">')'</span>);</span><br><span class="line">        String method = stringBuilder.toString();</span><br><span class="line">        logMessage.add(<span class="string">"method"</span>, method);</span><br><span class="line">        logMessage.add(<span class="string">"message"</span>, message);</span><br><span class="line">        logger.warn(logMessage.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>封装这一层的目的有两个，一是为了保持和controller层和service层相同的日志规范，把traceId、spanid、cspanid加上。二是为了当<code>error</code>级别日志进行记录时，能够把错误信息直接发送到公司监测群中，这样可以及时对系统进行问题排查。</p>
<p>从上述的介绍中，可以看出日志记录的全链路是从controller获取到请求开始，进入到service层业务处理，再到具体代码中异常情况日志记录。同时使用traceId、spanid和cspanid进行全链路日志记录，</p>
<blockquote>
<p>controller层 -&gt; service层 -&gt; 方法内部</p>
</blockquote>
<h2 id="0x02-接口类型"><a href="#0x02-接口类型" class="headerlink" title="0x02 接口类型"></a>0x02 接口类型</h2><p>接口类型的不同，日志记录的便重点也会所有不一样。平时工作接触的接口类型应该也就是web接口和api接口。这两种类型的接口不同之处是一般web接口都是面向用户，需要登录的接口；而api接口则是面向其他系统，使用token进行认证。存在的差异也就是导致日志记录的要求有所不同。</p>
<p>web接口可能会有审计要求，需要记录下是谁在什么时候请求了什么数据、接口。这种类型的日志记录最合适的地方就是登录验证的filter中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">log_audit.info(<span class="string">"auditlog||system=soc||hostIp="</span> + NetworkUtil.getRemoteHost((HttpServletRequest)request) </span><br><span class="line">    + <span class="string">"||userName="</span> + loginUser.getUsername() </span><br><span class="line">    + <span class="string">"||url="</span> + ((HttpServletRequest) request).getRequestURL() </span><br><span class="line">    + <span class="string">"||getParams="</span> + getQueryString </span><br><span class="line">    + <span class="string">"||postParams="</span> + postQueryString </span><br><span class="line">    + <span class="string">"||userIp="</span> + request.getRemoteAddr() </span><br><span class="line">    + <span class="string">"||timestamp="</span> + DateUtil.dateToStringCus(<span class="keyword">new</span> Date(), DateUtil.DATE_FORMAT_SHORT) </span><br><span class="line">    + <span class="string">"||respose= "</span>);</span><br></pre></td></tr></table></figure>

<p>在filter中对用户进行登录认证，如果已经登录就可以直接记录下用户请求的相关信息。而如果用户请求的是API接口，则进行token认证，并记录下clientId等相关信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">log_audit.info(<span class="string">"auditlog||system=soc||hostIp="</span> + NetworkUtil.getRemoteHost((HttpServletRequest)request) </span><br><span class="line">    + <span class="string">"||userName="</span> + <span class="string">"api_client_"</span> + clientId </span><br><span class="line">    + <span class="string">"||url="</span> + ((HttpServletRequest) request).getRequestURL() </span><br><span class="line">    + <span class="string">"||getParams="</span> + getQueryString </span><br><span class="line">    + <span class="string">"||postParams="</span> + postQueryString </span><br><span class="line">    + <span class="string">"||userIp="</span> + request.getRemoteAddr() </span><br><span class="line">    + <span class="string">"||timestamp="</span> + DateUtil.dateToStringCus(<span class="keyword">new</span> Date(),DateUtil.DATE_FORMAT_SHORT) </span><br><span class="line">    + <span class="string">"||respose= "</span>);</span><br></pre></td></tr></table></figure>

<p>另外需要注意的是，这两个日志记录语句都没有记录<code>response</code>的值。为什么？因为获取不到返回值。由于返回流的特性，只能获取一次<code>response</code>中的返回值，如果这里获取了，那么接口中返回值就没了。<code>request</code>中的参数也有相同的问题。</p>
<p>当然这里贴的代码是系统进行日志修改之前的代码，之后的代码是可以获取到返回值的。改进的方式是给<code>request</code>和<code>response</code>加上一层包装，我们经常见的包装类Wrapper。这里就不细说了，之后会在另外一篇文章中详细说。</p>
<p>OK。上面就是我在系统开发过程中日志记录。可能不是特别的规范和完善，但是针对现在的问题，这种方式可以有效地帮助我定位、解决问题。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-后端分层日志记录"><span class="toc-number">1.</span> <span class="toc-text">0x01 后端分层日志记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-接口类型"><span class="toc-number">2.</span> <span class="toc-text">0x02 接口类型</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://haocdp.github.io/2020/06/11/日志记录全流程/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&text=日志记录全流程"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&is_video=false&description=日志记录全流程"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=日志记录全流程&body=Check out this article: https://haocdp.github.io/2020/06/11/日志记录全流程/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&title=日志记录全流程"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://haocdp.github.io/2020/06/11/日志记录全流程/&name=日志记录全流程&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 haoc_dp
  </div>
  <!-- <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div> -->
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-148173917-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
